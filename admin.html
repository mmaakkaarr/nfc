<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NFC‚ÄëSOS ‚Äî –ê–¥–º–∏–Ω</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body{margin:0;font-family:Arial;background:#f0f4f8;color:#021018}
  header{padding:12px;background:#0b1220;color:white;text-align:center}
  #map{height:85vh}
  .popup-message{white-space: pre-wrap;}
</style>
</head>
<body>
<header><h2>üìç NFC‚ÄëSOS ‚Äî –ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h2></header>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ======= –í–ê–ñ–ù–û: –≤—Å—Ç–∞–≤—å—Ç–µ URL Apps Script ======= */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyOeUni8fKkWARp0iFBHpapU55b_2OnkHfuPdPmmdvp3-3g3i_b_JbsKosHjkA-AKrMjQ/exec";
/* =============================================== */

const map = L.map('map').setView([54.87,69.17], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

async function loadAlerts(){
  try {
    const res = await fetch(WEB_APP_URL + '?mode=json&limit=500');
    if(!res.ok) throw new Error('Network ' + res.status);
    const arr = await res.json();
    render(arr);
  } catch(err) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + err);
  }
}

function render(arr){
  arr.forEach(item => {
    if (!item.lat || !item.lng) return;
    const date = new Date(item.timestamp).toLocaleString();
    const message = item.message || "(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)";
    const anon = item.isAnonymous ? '–ê–Ω–æ–Ω–∏–º' : '–ù–µ –∞–Ω–æ–Ω–∏–º';
    const popup = `<b>${date}</b><br><i>${anon}</i><br><div class="popup-message">${escapeHtml(message)}</div>`;
    L.marker([item.lat, item.lng]).addTo(map).bindPopup(popup);
  });
}

function escapeHtml(s){
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

loadAlerts();
setInterval(loadAlerts, 10000);
</script>
</body>
</html>

