<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NFC-SOS Admin</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body{font-family:Arial;background:#f7fafc;color:#071226;margin:0;padding:12px}
.wrap{display:flex;gap:12px}
.left{flex:1}
.right{width:360px}
#map{height:72vh;border-radius:10px}
.card{background:white;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.entry{padding:8px;border-bottom:1px solid #eef2f7}
.anon{font-weight:700;color:#ff6b6b}
</style>
</head>
<body>
<div class="wrap">
<div class="left card"><div id="map"></div></div>
<div class="right card">
<h3>Последние тревоги</h3>
<div id="log" style="max-height:64vh;overflow:auto"></div>
</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SHEETDB_URL = "https://sheetdb.io/api/v1/loeua7zl5xak6";

let map = L.map('map').setView([54.87,69.17],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markerLayer;

async function fetchData(){
  try{
    const r = await fetch(SHEETDB_URL);
    const data = await r.json();
    const arr = data.reverse(); // последние сверху
    render(arr);
  }catch(err){
    console.error(err);
    document.getElementById('log').innerHTML='<div class="entry">Ошибка загрузки</div>';
  }
}

function render(arr){
  const log = document.getElementById('log');
  log.innerHTML='';
  if(markerLayer) map.removeLayer(markerLayer);
  markerLayer=L.layerGroup().addTo(map);

  if(arr.length===0){ log.innerHTML='<div class="entry">Нет записей</div>'; return; }

  arr.forEach(item=>{
    const lat=parseFloat(item.lat);
    const lng=parseFloat(item.lng);
    if(isNaN(lat) || isNaN(lng)) return;
    const t = new Date(item.timestamp).toLocaleString();
    const entry = document.createElement('div');
    entry.className='entry';
    let isAnon = item.isAnonymous==='true';
    let author = isAnon ? '<span class="anon">Аноним</span>' : (item.ua||'Неизвестно').substr(0,40);
    entry.innerHTML=`<div><b>${t}</b></div>
                     <div style="font-size:14px;margin-top:4px">${escapeHtml(item.message||'')}</div>
                     <div style="font-size:12px;color:#64748b;margin-top:4px">${lat.toFixed(6)}, ${lng.toFixed(6)} — ${author}</div>`;
    log.appendChild(entry);

    const markerColor = isAnon ? 'red' : 'blue';
    const icon = L.icon({iconUrl:`https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|${markerColor}`, iconSize:[21,34], iconAnchor:[10,34]});
    L.marker([lat,lng],{icon}).addTo(markerLayer).bindPopup(`<b>${t}</b><br>${escapeHtml(item.message||'')}<br>${author}`);
  });

  // центрируем на последнем сообщении
  const last = arr[0];
  if(last) map.setView([parseFloat(last.lat),parseFloat(last.lng)],15);
}

function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

fetchData();
setInterval(fetchData,8000);
</script>
</body>
</html>
