<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NFC-SOS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{font-family:Arial;background:#071026;color:#e7f3f7;margin:0;padding:0}
.wrap{max-width:720px;margin:20px auto;padding:15px}
textarea{width:100%;min-height:100px;padding:10px;border-radius:8px;border:none;background:#0b1622;color:#e7f3f7}
button{padding:10px 14px;border:none;border-radius:8px;background:#06b6d4;color:#012;cursor:pointer;font-weight:600;margin-top:8px}
#map{height:300px;margin-top:12px;display:none;border-radius:8px}
#status{margin-top:8px;color:#98a9b3}
</style>
</head>
<body>
<div class="wrap">
<h2>üö® NFC-SOS</h2>
<p>–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é:</p>
<textarea id="msg"></textarea>
<label><input type="checkbox" id="anon"> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ</label>
<br>
<button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<div id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ</div>
<div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SHEETDB_URL = "https://sheetdb.io/api/v1/loeua7zl5xak6";

const msgEl = document.getElementById('msg');
const anonEl = document.getElementById('anon');
const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');
const mapDiv = document.getElementById('map');
let map, marker;

function showMap(lat,lng){
  mapDiv.style.display='block';
  if(!map){
    map = L.map('map').setView([lat,lng],16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);
    marker = L.marker([lat,lng]).addTo(map).bindPopup('–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è').openPopup();
  } else {
    map.setView([lat,lng],16);
    marker.setLatLng([lat,lng]).openPopup();
  }
}

async function getCoords(){
  return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej(new Error("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"));
    navigator.geolocation.getCurrentPosition(p=>res(p.coords),e=>rej(e),{enableHighAccuracy:true,timeout:15000});
  });
}

async function sendData(payload){
  try{
    const res = await fetch(SHEETDB_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({data: payload})
    });
    if(!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: '+res.status);
    return await res.json();
  } catch(err){
    throw err;
  }
}

sendBtn.addEventListener('click', async ()=>{
  const text = msgEl.value.trim();
  if(text.length<3){ alert('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return; }
  sendBtn.disabled=true;
  statusEl.textContent='–ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã‚Ä¶';
  try{
    const coords = await getCoords();
    statusEl.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶';
    const payload = {
      timestamp: new Date().toISOString(),
      lat: coords.latitude.toString(),
      lng: coords.longitude.toString(),
      message: text,
      isAnonymous: anonEl.checked.toString(),
      tagId: "-",
      ua: navigator.userAgent || "-",
      url: window.location.href || "-"
    };
    await sendData(payload);
    statusEl.textContent='–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ';
    showMap(coords.latitude,coords.longitude);
  } catch(err){
    console.error(err);
    statusEl.textContent='–û—à–∏–±–∫–∞: '+err.message;
  } finally{
    sendBtn.disabled=false;
  }
});
</script>
</body>
</html>
