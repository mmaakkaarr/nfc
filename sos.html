<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NFC‚ÄëSOS</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root { --bg:#071026; --card:#0b1622; --accent:#06b6d4; --muted:#98a9b3; }
  html, body { margin:0; padding:0; height:100%; background:var(--bg); color: #e7f3f7; font-family: Inter, sans-serif; }
  .wrap { max-width: 720px; margin: 40px auto; padding: 0 16px; }
  .card { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
  h1 { margin: 0 0 10px; font-size: 24px; }
  .lead { color: var(--muted); margin-bottom: 20px; }
  textarea { width: 100%; min-height: 100px; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.04); background: transparent; color: inherit; resize: vertical; }
  .row { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
  .btn { background: var(--accent); color: #021018; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; flex: 1; }
  .btn:disabled { opacity: 0.6; cursor: default; }
  label.switch { display: inline-flex; align-items: center; gap: 6px; color: var(--muted); }
  .small { font-size: 13px; color: var(--muted); }
  #status { margin-top: 12px; }
  #map { height: 320px; margin-top: 20px; border-radius: 10px; display: none; }
  .footer { margin-top: 14px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); }
  .toast { position: fixed; right: 20px; bottom: 20px; background: rgba(8,18,38,0.9); color: #bff7ff; padding: 12px 14px; border-radius: 8px; display: none; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üö® NFC‚ÄëSOS</h1>
    <div class="lead">–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∏–≥–Ω–∞–ª ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã + —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ø–∞–¥—É—Ç –∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ.</div>

    <textarea id="msg" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏..." required></textarea>

    <div class="row">
      <label class="switch">
        <input type="checkbox" id="anon" />
        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ</span>
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å SOS</button>
    </div>

    <div id="status" class="small">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—É–¥—É—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è</div>

    <div id="map"></div>

    <div class="footer">
      <div class="small">–ï—Å–ª–∏ GPS –Ω–µ –≤–∫–ª—é—á—ë–Ω ‚Äî –≤–∫–ª—é—á–∏—Ç–µ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.</div>
      <div><a id="sheetLink" class="small" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –±–∞–∑—É</a></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ======= –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –≤–∞—à Apps Script WebApp ======= */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyOeUni8fKkWARp0iFBHpapU55b_2OnkHfuPdPmmdvp3-3g3i_b_JbsKosHjkA-AKrMjQ/exec";
/* =============================================================== */

const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');
const msgEl = document.getElementById('msg');
const anonEl = document.getElementById('anon');
const toast = document.getElementById('toast');
const sheetLink = document.getElementById('sheetLink');

sheetLink.href = WEB_APP_URL + "?mode=view";

function showToast(text) {
  toast.textContent = text;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

async function getCoords() {
  return new Promise((res, rej) => {
    if(!navigator.geolocation) rej('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    navigator.geolocation.getCurrentPosition(p => res(p.coords), e => rej(e.message || '–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏'), {enableHighAccuracy:true, timeout:15000});
  });
}

async function sendSOS() {
  const text = msgEl.value.trim();
  if (text.length < 3) {
    showToast('–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.');
    return;
  }
  sendBtn.disabled = true;
  statusEl.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç‚Ä¶';

  try {
    const coords = await getCoords();
    statusEl.textContent = `lat: ${coords.latitude.toFixed(5)}, lng: ${coords.longitude.toFixed(5)} ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶`;

    const tagId = new URLSearchParams(window.location.search).get('id') || '';

    const payload = {
      lat: coords.latitude,
      lng: coords.longitude,
      message: text,
      isAnonymous: !!anonEl.checked,
      tagId: tagId,
      ua: navigator.userAgent,
      url: window.location.href
    };

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: {'Content-Type':'application/json'}
    });
    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ' + res.status);

    statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ';
    showToast('–°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É
    showMap(coords.latitude, coords.longitude);

  } catch (e) {
    console.error(e);
    statusEl.textContent = '–û—à–∏–±–∫–∞ ‚Äî —Å–º. –∫–æ–Ω—Å–æ–ª—å';
    showToast('–û—à–∏–±–∫–∞: ' + e);
    sendBtn.disabled = false;
  }
}

function showMap(lat, lng) {
  const mapDiv = document.getElementById('map');
  mapDiv.style.display = 'block';
  if (!window._map) {
    window._map = L.map('map').setView([lat, lng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OSM' }).addTo(window._map);
    window._marker = L.marker([lat, lng]).addTo(window._map).bindPopup('–í—ã –∑–¥–µ—Å—å').openPopup();
  } else {
    window._marker.setLatLng([lat, lng]).openPopup();
    window._map.setView([lat, lng], 16);
  }
}

sendBtn.addEventListener('click', sendSOS);

if (WEB_APP_URL.includes('YOUR_GOOGLE_SCRIPT_WEB_APP_URL')) {
  statusEl.textContent = '‚ö† –ù–∞—Å—Ç—Ä–æ–π—Ç–µ WEB_APP_URL –≤ –∫–æ–¥–µ!';
  sendBtn.disabled = true;
  sheetLink.style.display = 'none';
}
</script>
</body>
</html>

