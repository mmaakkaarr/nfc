<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NFC-SOS ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root{--bg:#071026;--card:#0b1622;--accent:#06b6d4;--muted:#98a9b3;--danger:#ff6b6b}
  html,body{height:100%;margin:0;font-family:Inter,Arial;color:#e7f3f7;background:linear-gradient(180deg,#042231,#071026)}
  .wrap{max-width:720px;margin:28px auto;padding:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  h1{margin:0 0 6px;font-size:20px}
  .lead{color:var(--muted);margin-bottom:12px}
  textarea{width:100%;min-height:100px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#012; padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
  label.switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .small{color:var(--muted);font-size:13px}
  #map{height:320px;border-radius:10px;margin-top:14px;display:none}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px}
  .toast{position:fixed;right:18px;bottom:18px;background:#07202a;color:#bff7ff;padding:12px 14px;border-radius:10px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üö® NFC-SOS</h1>
    <div class="lead">–ü–æ–¥–Ω–µ—Å–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∫ –º–µ—Ç–∫–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ.</div>

    <div style="margin-bottom:10px">
      <textarea id="msg" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é (–∫—Ä–∞—Ç–∫–æ) ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å"></textarea>
    </div>

    <div class="row" style="margin-bottom:10px">
      <label class="switch">
        <input id="anon" type="checkbox" />
        <span class="small">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ</span>
      </label>
      <div style="flex:1"></div>
      <button id="send" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="status" class="small">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>

    <div id="map"></div>

    <div class="footer">
      <div class="small">–ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è ‚Äî –≤–∫–ª—é—á–∏—Ç–µ GPS –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
      <div><a id="sheetLink" class="small" href="#" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –±–∞–∑—É</a></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ========== –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô Apps Script URL ========== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyOeUni8fKkWARp0iFBHpapU55b_2OnkHfuPdPmmdvp3-3g3i_b_JbsKosHjkA-AKrMjQ/exec"; // <-- –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ URL –∏–∑ Google Apps Script (deploy web app)
/* ================================================================= */

const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');
const msgEl = document.getElementById('msg');
const anonEl = document.getElementById('anon');
const toast = document.getElementById('toast');
const mapDiv = document.getElementById('map');
const sheetLink = document.getElementById('sheetLink');

sheetLink.href = WEB_APP_URL + "?mode=view";

function showToast(t){
  toast.textContent = t;
  toast.style.display = 'block';
  setTimeout(()=> toast.style.display='none', 3500);
}

async function getCoords(){
  return new Promise((res, rej) => {
    if(!navigator.geolocation) return rej(new Error("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"));
    navigator.geolocation.getCurrentPosition(p => res(p.coords), e => rej(e), {enableHighAccuracy:true, timeout:15000});
  });
}

async function sendPayload(payload){
  const res = await fetch(WEB_APP_URL, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: {'Content-Type':'application/json'}
  });
  if(!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + res.status);
  return await res.json();
}

function showMap(lat,lng){
  mapDiv.style.display = 'block';
  if(!window._sos_map){
    window._sos_map = L.map('map', {zoomControl:true}).setView([lat,lng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(window._sos_map);
    window._sos_marker = L.marker([lat,lng]).addTo(window._sos_map).bindPopup('–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è').openPopup();
  } else {
    window._sos_map.setView([lat,lng], 16);
    window._sos_marker.setLatLng([lat,lng]).openPopup();
  }
}

sendBtn.addEventListener('click', async () => {
  const text = msgEl.value.trim();
  if(text.length < 3){
    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –∫—Ä–∞—Ç–∫–æ (3+ —Å–∏–º–≤–æ–ª–∞).');
    return;
  }
  statusEl.textContent = '–°—Ç–∞—Ç—É—Å: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç‚Ä¶';
  sendBtn.disabled = true;
  try {
    const coords = await getCoords();
    statusEl.textContent = `–°—Ç–∞—Ç—É—Å: –û—Ç–ø—Ä–∞–≤–∫–∞ (lat ${coords.latitude.toFixed(6)} lng ${coords.longitude.toFixed(6)})`;
    const tagId = new URLSearchParams(window.location.search).get('id') || '';
    const payload = {
      lat: coords.latitude,
      lng: coords.longitude,
      message: text,
      isAnonymous: !!anonEl.checked,
      tagId: tagId,
      ua: navigator.userAgent,
      url: window.location.href
    };
    await sendPayload(payload);
    statusEl.textContent = '–°—Ç–∞—Ç—É—Å: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ';
    showToast('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.');
    showMap(coords.latitude, coords.longitude);
    sendBtn.disabled = true;
  } catch(err) {
    console.error(err);
    statusEl.textContent = '–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ ‚Äî —Å–º. –∫–æ–Ω—Å–æ–ª—å';
    showToast('–û—à–∏–±–∫–∞: ' + (err.message || err));
    sendBtn.disabled = false;
  }
});

// –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ WEB_APP_URL –Ω–µ –∑–∞–º–µ–Ω—ë–Ω
if(WEB_APP_URL.includes('YOUR_WEB_APP_URL')){
  statusEl.textContent = '–°—Ç–∞—Ç—É—Å: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ WEB_APP_URL –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ (Apps Script URL).';
  sendBtn.disabled = true;
  sheetLink.style.display = 'none';
}
</script>
</body>
</html>
